<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Imoveis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.0/build/global/luxon.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator_bootstrap4.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<!-- https://getbootstrap.com/docs/5.3/forms/layout/ -->

<body>
    <div class="container" style="margin-top: 15px;">

        <div class="row justify-content-between">
            <div class="col-3">
                <h1>Imóveis</h1>
            </div>
            <div class="col-3">
                <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter"
                    aria-expanded="false" aria-controls="collapseFilter">
                    <i class="bi bi-eye"></i> Filtros
                </button>
            </div>
        </div>


        <div class="collapse row g-3" id="collapseFilter">
            <div class="col-md-6">
                <label for="nome" class="form-label">Nome</label>
                <input class="form-control" id="nome">
            </div>
            <div class="col-md-6">
                <label for="tipo" class="form-label">Tipo</label>
                <select id="tipo" class="form-select">
                    <option selected>Todos</option>
                    <option>Apartamento</option>
                    <option>Casa</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="endereco" class="form-label">Endereço</label>
                <input class="form-control" id="endereco">
            </div>
            <div class="col-md-6">
                <label for="bairro" class="form-label">Bairro</label>
                <input class="form-control" id="bairro">
            </div>
            <div class="col-md-6">
                <label for="valorMin" class="form-label">Valor Min</label>
                <input class="form-control" id="valorMin">
            </div>
            <div class="col-md-6">
                <label for="valorMax" class="form-label">Valor Máx</label>
                <input class="form-control" id="valorMax">
            </div>
            <div class="col-md-6">
                <label for="situacao" class="form-label">Situaçãoo</label>
                <select id="situacao" class="form-select">
                    <option selected>Todos</option>
                    <option>Ocupado</option>
                    <option>Desocupado</option>
                </select>
            </div>
            <div class="col-12">
                <div class="d-grid gap-2">
                    <button id="searchBtn" type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </div>
        </div>

        <div id="myTable"></div>

    </div>
</body>

<script>
    $(document).ready(function () {
        function loadItems(filter = {}) {
            $.ajax({
                url: 'https://corsproxy.io/?' + encodeURIComponent(`http://nodered.thiagosol.com/auction/properties?${$.param(filter)}`), // Substitua com a URL da sua API
                data: {},
                method: 'GET',
                success: function (data) {
                    const itemsList = $('#items-list');
                    itemsList.empty();

                    if (data.properties.length > 0) {
                        const moneyFormatterParams = {
                            decimal: ",",
                            thousand: ".",
                            symbol: "R$",
                            symbolAfter: false,
                            precision: 2
                        }

                        const propertiesFormatted = data.properties.map(p => {
                            return {
                                Nome: p.title,
                                Tipo: p.type,
                                Bairro: p.neighborhood,
                                Valor_Avaliacao: p.appraisal_value,
                                Valor: p.value,
                                Desconto: p.discount,
                                Data: p.auction_date,
                                Situacao: p.situation,
                            }
                        })
                        var table = new Tabulator("#myTable", {
                            data: propertiesFormatted, // jsonData é o array JSON
                            //autoColumns: true, // Ativa a geração automática de colunas
                            //layout:"fitColumns", 
                            responsiveLayout: "collapse", // Layout responsivo para colapsar colunas    
                            //responsiveLayout:"hide",  //hide columns that don't fit on the table
                            pagination: "local",       //paginate the data
                            paginationSize: 20,         //allow 20 rows per page of data
                            paginationCounter: "rows", //display count of paginated rows in footer
                            columns: [                 //define the table columns
                                { title: "Imóvel", field: "Nome" },
                                { title: "Tipo", field: "Tipo" },
                                { title: "Bairro", field: "Bairro" },
                                { title: "Valor", field: "Valor", formatter: "money", formatterParams: moneyFormatterParams },
                                { title: "Valor Avaliação", field: "Valor_Avaliacao", formatter: "money", formatterParams: moneyFormatterParams },
                                { title: "Desconto", field: "Desconto" },
                                { title: "Situacão", field: "Situacao" },
                                {
                                    title: "Data", field: "Data",
                                    formatter: "datetime",
                                    formatterParams: {
                                        inputFormat: "iso",
                                        outputFormat: "dd/MM/yyyy HH:mm", // Formato da data
                                        timezone: "America/Sao_Paulo", // Define o fuso horário
                                        invalidPlaceholder: "---" // Placeholder para datas inválidas
                                    }
                                }
                            ],
                        });
                    } else {
                        itemsList.append('<div class="item">Nenhum item encontrado.</div>');
                    }

                },
                error: function () {
                    alert('Erro ao carregar os itens.');
                }
            });
        }

        $('#searchBtn').click(function () {
            const filter = {
                nome: $('#nome').val(),
                tipo: $('#tipo').val()  == 'Todos' ? '' : $('#tipo').val(),
                endereco: $('#endereco').val(),
                bairro: $('#bairro').val(),
                valorMin: $('#valorMin').val(),
                valorMax: $('#valorMax').val(),
                situacao: $('#situacao').val() == 'Todos' ? '' : $('#situacao').val()
            }
            loadItems(filter);
        });

        loadItems(); // Carrega os itens ao iniciar a página
    });
</script>

</html>